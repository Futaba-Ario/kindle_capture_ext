# Kindle Capture Extension

Cloud Reader上の本を自動でページ送りしながらキャプチャし、PDFとして保存する Chrome 拡張機能です。

## 機能
- **自動ページ送り**: 指定したページ数分、自動で右（または左）へページをめくります。
- **スクリーンショット撮影**: 各ページを `jpeg/png` でキャプチャできます。
- **PDF生成**: 取得した画像を結合し、1つのPDFファイルとしてダウンロードします。
- **オフスクリーン処理**: 画像処理をバックグラウンド（Offscreen）で行うため、ブラウザ操作への影響を抑えます。
- **安定化オプション**: リサイズ、チェックポイント保存、適応待機、品質フォールバックに対応しています。

## インストール方法
1. このフォルダーをリポジトリとしてクローンまたはダウンロードします。
   - 必要なファイル: `manifest.json`, `src/`, `lib/`, `icons/` 等
2. Chrome ブラウザで `chrome://extensions` を開きます。
3. 右上の **デベロッパーモード** をオンにします。
4. **「パッケージ化されていない拡張機能を読み込む」 (Load unpacked)** をクリックします。
5. この拡張機能のルートディレクトリ（`kindle_capture_ext`）を選択します。

## 使い方
1. [Kindle Cloud Reader](https://read.amazon.co.jp) にアクセスし、本を開きます。
2. ブラウザ右上の拡張機能アイコンをクリックしてポップアップを開きます。
3. **設定**:
   - **ページ数**: キャプチャしたいページ数を入力します（例: 50）。
   - **待機(ms)**: ページめくり後の待機時間です（デフォルト 1500ms）。回線速度や描画速度に合わせて調整してください。
   - **分割(頁)**: 指定したページ数ごとにPDFファイルを分割保存します（例: 50ページごとに保存）。0の場合は分割しません。メモリ不足回避や管理のしやすさに役立ちます。
   - **詳細設定 (安定化)**:
     - **形式**: `jpeg`（推奨）または `png` を選択します。
     - **JPEG品質**: 10〜100（デフォルト 82）。値を下げるほどファイルサイズとメモリ負荷が下がります。
     - **長辺上限(px)**: 画像の長辺をこの値まで縮小してPDFに埋め込みます（デフォルト 2200）。
     - **チェックポイント頁**: 指定ページごとに内部PDFを一時確定してメモリピークを抑えます（デフォルト 20）。
     - **適応待機**: ページ処理時間に応じて待機時間を自動調整します。
     - **最小待機(ms) / 最大待機(ms)**: 適応待機時の下限・上限です（デフォルト 900 / 3500）。
4. **「開始 (PDF)」** ボタンをクリックします。
   - 自動的にページがめくられ、撮影が進みます。
   - 処理中はポップアップにステータスとメトリクス（段階、待機時間、推定容量、フォールバック段階）が表示されます。
5. 完了すると `kindle_book_YYYY-MM-DD...pdf` が自動的にダウンロードされます。
6. 途中で止めたい場合は **「停止」** ボタンを押してください（現在のページまでで処理を終了し、そこまでのPDFを生成します）。

## 安定化の挙動
- **適応待機**: 各ページの処理時間をもとに次の待機時間を自動調整し、負荷スパイクを抑えます。
- **内部チェックポイント**: 設定した間隔でPDFを内部確定し、長時間のメモリ滞留を避けます。
- **段階的フォールバック**: 保存失敗やメモリ逼迫時に、`JPEG品質低下 -> 長辺上限縮小 -> 分割推奨` の順で回復を試みます。
- **分割との併用**: 分割(頁)が0でも上記安定化は有効です。大容量時は分割併用を推奨します。

## 注意事項
- **著作権**: 私的利用の範囲内でのみ使用してください。
- **DRM**: 画面が黒くなる場合はハードウェアアクセラレーションを無効にするなどのブラウザ設定が必要な場合がありますが、本ツールはDRM回避を行いません。
- **メモリ**: 大量（数百ページ以上）のページを一気にPDF化すると、ブラウザのメモリ制限によりクラッシュする可能性があります。安定化設定を使っても厳しい場合は、50〜100ページ程度で分割保存してください。
- **推奨初期値**: 分割なしで重い場合は `jpeg / 品質70〜82 / 長辺1800〜2200 / チェックポイント20` を目安に調整してください。
